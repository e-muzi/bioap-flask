{% extends 'base.html' %}
{% block title %}Analysis - BioAP{% endblock %}
{% block content %}
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Run Analysis</h5>
      <form method="post" action="{{ url_for('analysis.analysis_preview') }}" enctype="multipart/form-data" class="row g-3" id="analysis-form">
        <div class="col-12 col-lg-4">
          <label class="form-label">Source</label>
          <div class="d-flex align-items-center gap-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="source_choice" id="source-upload" value="upload" checked>
              <label class="form-check-label" for="source-upload">Upload file</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="source_choice" id="source-camera" value="camera">
              <label class="form-check-label" for="source-camera">Capture with camera</label>
            </div>
          </div>
          <div id="upload-group" class="mt-2">
            <input type="file" class="form-control" id="file-upload" name="image" accept="image/*,.jpg,.jpeg,.png,.webp,.heic,.heif,.bmp,.tif,.tiff">
            <div class="form-text">Pick an existing file from your phone or computer.</div>
          </div>
          <div id="camera-group" class="mt-2 d-none">
            <input type="file" class="form-control" id="file-camera" accept="image/*" capture="environment">
            <div class="form-text">Open your device camera to take a photo.</div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Or capture using your camera</div>
              <a href="{{ url_for('analysis.camera') }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-camera"></i>
                <span class="ms-1">Open camera</span>
              </a>
            </div>
            <div class="form-text mt-2">Open the dedicated camera page to capture a photo, then you'll return here for analysis.</div>
          </div>
        </div>
        <div class="col-12 {% if scientific_mode %}d-none{% endif %}">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="normalize" id="normalize">
            <label class="form-check-label" for="normalize">
              Use background normalization (auto from corner)
            </label>
          </div>
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">Analyze</button>
        </div>
      </form>
    </div>
  </div>

  {% if image_path and results %}
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h6 class="mb-3">Uploaded image</h6>
          <div class="position-relative d-inline-block">
            <img id="analyzed-img" src="/{{ image_path }}" class="img-fluid rounded border" alt="uploaded">
            {% for r in results %}
              {% set left_pct = (r.x / width * 100.0) %}
              {% set top_pct = (r.y / height * 100.0) %}
              {% if scientific_mode %}
                {% set dot_colors = ['var(--bs-primary)', 'var(--bs-success)', 'var(--bs-info)', 'var(--bs-warning)', 'var(--bs-danger)'] %}
                {% set dot_color = dot_colors[loop.index0 % 5] %}
                <div class="position-absolute translate-middle"
                     data-left-pct="{{ '%.2f'|format(left_pct) }}"
                     data-top-pct="{{ '%.2f'|format(top_pct) }}"
                     data-dot-color="{{ dot_color }}">
                  <span class="d-inline-block rounded-circle analysis-dot" style="width: 14px; height: 14px; border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(0,0,0,.2);"></span>
                </div>
              {% else %}
                <div class="position-absolute translate-middle"
                     data-left-pct="{{ '%.2f'|format(left_pct) }}"
                     data-top-pct="{{ '%.2f'|format(top_pct) }}"
                     data-dot-color="var(--bs-primary)">
                  <span class="d-inline-block rounded-circle analysis-dot" style="width: 14px; height: 14px; border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), .5);"></span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <div class="small text-muted mt-2">Markers show the N sampling points used (center + 4 neighbors per point).</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Results</h6>
            {% if run_id %}
            <a href="{{ url_for('history.import_to_calibration', run_id=run_id) }}" class="btn btn-sm btn-outline-primary">Import to calibration</a>
            {% endif %}
          </div>
          <div class="table-responsive">
            {% if scientific_mode %}
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Point</th>
                  <th>RGB</th>
                  <th>HEX</th>
                  <th>HSV</th>
                  <th>HSL</th>
                </tr>
              </thead>
              <tbody>
                {% for r in results %}
                <tr>
                  <td>{{ r.pesticide_name }}</td>
                  <td>{{ r.scientific_data.rgb[0] }}, {{ r.scientific_data.rgb[1] }}, {{ r.scientific_data.rgb[2] }}</td>
                  <td><code class="small">{{ r.scientific_data.hex }}</code></td>
                  <td class="small">{{ r.scientific_data.hsv }}</td>
                  <td class="small">{{ r.scientific_data.hsl }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Pesticide</th>
                  <th class="text-end">RGB total</th>
                  <th class="text-end">Concentration</th>
                  <th class="text-end">Level</th>
                </tr>
              </thead>
              <tbody>
                {% for r in results %}
                <tr>
                  <td>{{ r.pesticide_name }}</td>
                  <td class="text-end">{{ r.rgb_sum }}</td>
                  <td class="text-end">{{ '%.2f'|format(r.concentration) }}</td>
                  <td class="text-end">
                    {% set badge = 'success' if r.level == 'Low' else ('warning' if r.level == 'Medium' else ('danger' if r.level == 'High' else 'secondary')) %}
                    <span class="badge bg-{{ badge }}">{{ r.level }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% if image_path and points and not results %}
  <div class="card">
    <div class="card-body">
      <h6 class="mb-3">Adjust sampling points</h6>
      <div class="position-relative d-inline-block" id="preview-container">
        <img id="preview-img" src="/{{ image_path }}" class="img-fluid rounded border" alt="preview" data-img-width="{{ width }}" data-img-height="{{ height }}">
        {% for p in points %}
          {% set left_pct = (p.x / width * 100.0) %}
          {% set top_pct = (p.y / height * 100.0) %}
          {% if scientific_mode %}
            {% set dot_colors = ['var(--bs-primary)', 'var(--bs-success)', 'var(--bs-info)', 'var(--bs-warning)', 'var(--bs-danger)'] %}
            {% set dot_color = dot_colors[loop.index0 % 5] %}
            <div class="drag-point position-absolute translate-middle"
                 data-index="{{ loop.index0 }}"
                 data-left-pct="{{ '%.2f'|format(left_pct) }}"
                 data-top-pct="{{ '%.2f'|format(top_pct) }}"
                 data-dot-color="{{ dot_color }}">
              <span class="d-inline-block rounded-circle analysis-dot" style="width: 16px; height: 16px; border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(0,0,0,.2); cursor: grab;"></span>
            </div>
          {% else %}
            <div class="drag-point position-absolute translate-middle"
                 data-index="{{ loop.index0 }}"
                 data-left-pct="{{ '%.2f'|format(left_pct) }}"
                 data-top-pct="{{ '%.2f'|format(top_pct) }}"
                 data-dot-color="var(--bs-danger)">
              <span class="d-inline-block rounded-circle analysis-dot" style="width: 16px; height: 16px; border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(var(--bs-danger-rgb), .5); cursor: grab;"></span>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <form method="post" action="{{ url_for('analysis.analysis_compute') }}" class="mt-3 d-flex flex-wrap gap-2" id="compute-form">
        <input type="hidden" name="points_json" id="points_json">
        <input type="hidden" name="image_path" value="{{ image_path }}">
        <div class="form-check {% if scientific_mode %}d-none{% endif %}">
          <input class="form-check-input" type="checkbox" name="normalize" id="normalize2">
          <label class="form-check-label" for="normalize2">
            Use background normalization (auto from corner)
          </label>
        </div>
        <div class="ms-auto">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="distributeBtn">Distribute evenly</button>
          <button type="submit" class="btn btn-primary">Analyze</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function() {
      const img = document.getElementById('preview-img');
      const container = document.getElementById('preview-container');
      const dots = Array.from(container.querySelectorAll('.drag-point'));
      const W = parseInt(img.getAttribute('data-img-width'), 10) || (img.naturalWidth || 0);
      const H = parseInt(img.getAttribute('data-img-height'), 10) || (img.naturalHeight || 0);
      // Initialize positions and dot colors for any elements with data-left-pct/top-pct
      document.querySelectorAll('[data-left-pct][data-top-pct]').forEach(function(el){
        const lp = parseFloat(el.getAttribute('data-left-pct'));
        const tp = parseFloat(el.getAttribute('data-top-pct'));
        if (!Number.isNaN(lp) && !Number.isNaN(tp)) {
          el.style.left = lp.toFixed(2) + '%';
          el.style.top = tp.toFixed(2) + '%';
        }
        const dotColor = el.getAttribute('data-dot-color');
        if (dotColor) {
          const dot = el.classList.contains('analysis-dot') ? el : el.querySelector('.analysis-dot');
          if (dot) dot.style.background = dotColor;
        }
      });
      let points = dots.map(dot => {
        const leftPct = parseFloat(dot.style.left) || 0;
        const topPct = parseFloat(dot.style.top) || 0;
        return {
          x: Math.round(W * leftPct / 100),
          y: Math.round(H * topPct / 100)
        };
      });

      function updateHidden() {
        const out = dots.map((el, i) => points[i]);
        document.getElementById('points_json').value = JSON.stringify(out);
      }

      function percentToPx(leftPct, topPct) {
        const rect = img.getBoundingClientRect();
        return {
          x: leftPct / 100 * W,
          y: topPct / 100 * H
        };
      }
      function pxToPercent(x, y) {
        return {
          left: (x / W * 100),
          top: (y / H * 100)
        };
      }
      function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

      function makeDraggable(dot) {
        let dragging = false;
        let idx = parseInt(dot.dataset.index, 10);
        function onDown(e) {
          e.preventDefault();
          dragging = true;
          dot.style.cursor = 'grabbing';
        }
        function onMove(e) {
          if (!dragging) return;
          const rect = img.getBoundingClientRect();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          const rx = clamp(clientX - rect.left, 0, rect.width);
          const ry = clamp(clientY - rect.top, 0, rect.height);
          // Convert from display px to image px
          const x = rx / rect.width * W;
          const y = ry / rect.height * H;
          points[idx].x = Math.round(x);
          points[idx].y = Math.round(y);
          const pct = pxToPercent(points[idx].x, points[idx].y);
          dot.style.left = pct.left.toFixed(2) + '%';
          dot.style.top = pct.top.toFixed(2) + '%';
        }
        function onUp(e) {
          dragging = false;
          dot.style.cursor = 'grab';
          updateHidden();
        }
        dot.addEventListener('mousedown', onDown);
        dot.addEventListener('touchstart', onDown);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove);
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchend', onUp);
      }

      dots.forEach(makeDraggable);
      updateHidden();

      document.getElementById('distributeBtn')?.addEventListener('click', function() {
        const rect = img.getBoundingClientRect();
        const n = dots.length;
        const y = Math.round(H / 2);
        for (let i = 0; i < n; i++) {
          const x = Math.round((i + 1) * (W / (n + 1)));
          points[i].x = x; points[i].y = y;
          const pct = pxToPercent(x, y);
          dots[i].style.left = pct.left.toFixed(2) + '%';
          dots[i].style.top = pct.top.toFixed(2) + '%';
        }
        updateHidden();
      });
    })();
  </script>
  {% endif %}
  <script>
    (function() {
      // Apply left/top and dot color for any elements that carry data attributes
      document.querySelectorAll('[data-left-pct][data-top-pct]').forEach(function(el){
        const lp = parseFloat(el.getAttribute('data-left-pct'));
        const tp = parseFloat(el.getAttribute('data-top-pct'));
        if (!Number.isNaN(lp) && !Number.isNaN(tp)) {
          el.style.left = lp.toFixed(2) + '%';
          el.style.top = tp.toFixed(2) + '%';
        }
        const dotColor = el.getAttribute('data-dot-color');
        if (dotColor) {
          const dot = el.classList.contains('analysis-dot') ? el : el.querySelector('.analysis-dot');
          if (dot) dot.style.background = dotColor;
        }
      });
    })();
  </script>
  <script>
    (function() {})();
  </script>
  <script>
    (function() {
      const uploadRadio = document.getElementById('source-upload');
      const cameraRadio = document.getElementById('source-camera');
      const uploadGroup = document.getElementById('upload-group');
      const cameraGroup = document.getElementById('camera-group');
      const uploadInput = document.getElementById('file-upload');
      const cameraInput = document.getElementById('file-camera');
      const form = document.getElementById('analysis-form');
      if (!uploadRadio || !cameraRadio || !uploadGroup || !cameraGroup || !uploadInput || !cameraInput || !form) return;
      function selectUpload() {
        uploadGroup.classList.remove('d-none');
        cameraGroup.classList.add('d-none');
        uploadInput.setAttribute('name', 'image');
        cameraInput.removeAttribute('name');
        cameraInput.value = '';
      }
      function selectCamera() {
        cameraGroup.classList.remove('d-none');
        uploadGroup.classList.add('d-none');
        cameraInput.setAttribute('name', 'image');
        uploadInput.removeAttribute('name');
        uploadInput.value = '';
      }
      function applySelection() {
        if (cameraRadio.checked) selectCamera(); else selectUpload();
      }
      uploadRadio.addEventListener('change', applySelection);
      cameraRadio.addEventListener('change', applySelection);
      form.addEventListener('submit', applySelection);
      applySelection();
    })();
  </script>
{% endblock %}
