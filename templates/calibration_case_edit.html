{% extends 'base.html' %}
{% block title %}Edit case - BioAP{% endblock %}
{% block content %}
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-2">Edit case: {{ case.display_name }}</h5>
      <p class="text-muted small mb-3">Profile: <strong>{{ profile.name }}</strong>. Update case details and calibration dataset (concentration vs RGB).</p>
      <form method="post" action="{{ url_for('calibration_case_edit', profile_id=profile.id, pesticide_id=case.id) }}">
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Display name</label>
            <input type="text" name="display_name" class="form-control" value="{{ case.display_name }}" required>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Key (identifier)</label>
            <input type="text" name="key" class="form-control" value="{{ case.key }}" required placeholder="e.g. case_1">
            <div class="form-text">Unique key for this case in the profile (letters, numbers, underscores).</div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Calibration points (concentration vs RGB total)</label>
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-row">Add row</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="points-table">
              <thead>
                <tr>
                  <th style="width: 160px;">Concentration</th>
                  <th style="width: 160px;">RGB total (R+G+B)</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody id="points-tbody">
                {% for row in points %}
                <tr>
                  <td>
                    <input type="number" step="0.01" class="form-control form-control-sm" name="concentration-{{ loop.index0 }}" value="{{ '%.2f'|format(row.concentration) }}" required>
                  </td>
                  <td>
                    <input type="number" step="1" class="form-control form-control-sm" name="rgb-{{ loop.index0 }}" value="{{ row.rgb_sum }}" required>
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Remove row">×</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="form-text">At least 2 points; concentrations must be unique; RGB must strictly decrease as concentration increases.</div>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Save case</button>
          <a href="{{ url_for('calibration') }}" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function() {
      var tbody = document.getElementById('points-tbody');
      var addBtn = document.getElementById('add-row');
      var rowIndex = tbody.querySelectorAll('tr').length;

      function addRow(concentration, rgb) {
        concentration = concentration === undefined ? 0 : concentration;
        rgb = rgb === undefined ? 200 : rgb;
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td><input type="number" step="0.01" class="form-control form-control-sm" name="concentration-' + rowIndex + '" value="' + concentration + '" required></td>' +
          '<td><input type="number" step="1" class="form-control form-control-sm" name="rgb-' + rowIndex + '" value="' + rgb + '" required></td>' +
          '<td><button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Remove row">×</button></td>';
        tbody.appendChild(tr);
        rowIndex++;
        tr.querySelector('.remove-row').addEventListener('click', function() { removeRow(tr); });
      }

      function removeRow(tr) {
        if (tbody.querySelectorAll('tr').length <= 2) return;
        tr.remove();
        reindexRows();
      }

      function reindexRows() {
        var rows = tbody.querySelectorAll('tr');
        rowIndex = 0;
        rows.forEach(function(tr) {
          var concInput = tr.querySelector('input[name^="concentration-"]');
          var rgbInput = tr.querySelector('input[name^="rgb-"]');
          if (concInput && rgbInput) {
            concInput.name = 'concentration-' + rowIndex;
            rgbInput.name = 'rgb-' + rowIndex;
            rowIndex++;
          }
        });
      }

      addBtn.addEventListener('click', function() { addRow(); });
      tbody.querySelectorAll('.remove-row').forEach(function(btn) {
        btn.addEventListener('click', function() { removeRow(btn.closest('tr')); });
      });
    })();
  </script>
{% endblock %}
